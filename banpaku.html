<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>After Expo – 行く→撮る→たまる</title>
  <style>
    :root { --base:#0f172a; --muted:#64748b; --card:#ffffff; --line:#e2e8f0; --accent:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--base); background:#f8fafc}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px}
    header h1{margin:0;font-size:18px}
    main{padding:16px;max-width:720px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .spot-title{font-weight:600}
    .dist{font-size:12px;color:var(--muted)}
    button{appearance:none;border:0;background:var(--accent);color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
    button[disabled]{background:#e2e8f0 !important;color:#94a3b8 !important;border:1px solid #e2e8f0 !important;cursor:not-allowed}
    #spotList > .card{margin-bottom:10px}
    h2{font-size:16px;margin:16px 0 8px}
    #stampGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    #stampGrid figure{margin:0}
    #stampGrid img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    #stampGrid figcaption{font-size:11px;color:var(--muted);padding:4px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .hint{font-size:12px;color:var(--muted);padding:8px}
    .footer{margin:24px 0 8px;font-size:12px;color:var(--muted);text-align:center}

    /* ダッシュボード */
    .kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .kpi{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:10px;text-align:center}
    .kpi .num{font-size:20px;font-weight:800}
    .kpi .label{font-size:12px;color:var(--muted)}
    .progress{height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;width:0%;background:var(--accent);transition:width .3s ease}
    .rate-label{font-size:12px;color:var(--muted);text-align:right;margin-top:4px}
  </style>
</head>
<body>
  <header>
    <h1>After Expo – 行く→撮る→たまる</h1>
  </header>

  <main>
    <!-- ダッシュボード -->
    <section class="card">
      <div class="row" style="align-items:flex-start">
        <div>
          <div class="spot-title">ダッシュボード</div>
          <div class="dist">進捗をひと目でチェック</div>
        </div>
        <div class="toolbar">
          <button id="btnRefresh" class="ghost" title="現在地から並べ直す">並べ直す</button>
          <button id="btnClear" class="ghost" title="端末内のスタンプのみ削除">スタンプ消去</button>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi">
          <div class="num" id="statTotal">0</div>
          <div class="label">スポット数</div>
        </div>
        <div class="kpi">
          <div class="num" id="statVisited">0</div>
          <div class="label">訪問済み</div>
        </div>
        <div class="kpi">
          <div class="num" id="statRate">0%</div>
          <div class="label">達成率</div>
        </div>
      </div>
      <div class="progress" style="margin-top:10px"><div id="progressBar"></div></div>
      <div class="rate-label" id="locStatus">現在地の取得を待機中…</div>
    </section>

    <!-- 近い順リスト -->
    <section class="card" style="margin-top:12px">
      <div class="spot-title" style="margin-bottom:8px">近い順スポット</div>
      <div id="spotList" class="hint">位置情報の許可後、ここに近い順で表示されます。</div>
    </section>

    <!-- スタンプ帳 -->
    <section>
      <h2>スタンプ帳</h2>
      <div id="stampGrid" class="card">
        <p class="hint">まだスタンプはありません。スポットでチェックインして写真を撮るとここに貯まります。</p>
      </div>
    </section>

    <p class="footer">データはこの端末内（localStorage）に保存されます。</p>
  </main>

  <!-- フォルダ（ギャラリー）から選ぶ用：capture指定なし -->
  <input id="camera" type="file" accept="image/*" hidden />

  <script>
  (function(){
    'use strict';
    // @ts-check

    /** @typedef {'exhibit'|'food'|'event'|'shop'} Category */
    /** @typedef {{id:string,name:string,category:Category,lat:number,lng:number,radius_m:number,hint?:string}} Spot */
    /** @typedef {{id:string,spotId:string,spotName:string,category:Category,takenAtISO:string,photoDataUrl:string,distance_m:number}} Stamp */

    /** ---- ここをあなたの行ける場所に差し替え ---- */
    /** @type {Spot[]} */
    const SPOTS = [
      { id:'s01', name:'中之島 再展示ギャラリー', category:'exhibit', lat:34.63752, lng:135.06729, radius_m:120, hint:'入口の看板が撮りやすい' },
      { id:'s02', name:'各国グルメ キッチン',     category:'food', lat:34.63752, lng:135.06729, radius_m:120, hint:'料理のアップがおすすめ' },
      { id:'s03', name:'万博メモリアルショップ',   category:'shop', lat:34.7429456, lng:135.5230246, radius_m:120, hint:'外観やレシートでもOK' },
    ];

    // ---- ストレージ ----
    const KEY = 'after_expo_stamps_v1';
    const loadStamps = () => { try { return /** @type {Stamp[]} */(JSON.parse(localStorage.getItem(KEY) || '[]')); } catch { return []; } };
    const saveStamp = (s) => { const arr = loadStamps(); arr.unshift(s); localStorage.setItem(KEY, JSON.stringify(arr)); };
    const clearStamps = () => localStorage.removeItem(KEY);
    const isVisited = (id) => loadStamps().some(s => s.spotId === id);

    // ---- ユーティリティ ----
    const toRad = d => d * Math.PI / 180;
    const distanceMeters = (aLat,aLng,bLat,bLng) => {
      const R = 6371000, dLat = toRad(bLat - aLat), dLng = toRad(bLng - aLng);
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const aa = s1*s1 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(aa));
    };
    const nowISO = () => new Date().toISOString();
    const formatDT = (iso) => { try { return new Date(iso).toLocaleString('ja-JP',{hour12:false}); } catch { return iso; } };

    function resizeImageFileToDataURL(file, maxW=1024){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = () => {
          const scale = Math.min(1, maxW / img.width);
          const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          if (!ctx) { reject(new Error('Canvas 2D が取得できません')); return; }
          ctx.drawImage(img,0,0,w,h);
          resolve(canvas.toDataURL('image/jpeg', 0.9));
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    function getPosition(){
      return new Promise((res,rej)=>{
        if(!navigator.geolocation){ rej(new Error('この端末は位置情報に非対応です')); return; }
        navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
      });
    }

    // ---- ダッシュボード ----
    function renderDashboard(){
      const total = SPOTS.length;
      const visited = new Set(loadStamps().map(s => s.spotId)).size;
      const rate = total ? Math.round((visited / total) * 100) : 0;

      const elTotal = document.getElementById('statTotal');
      const elVisited = document.getElementById('statVisited');
      const elRate = document.getElementById('statRate');
      const bar = document.getElementById('progressBar');

      if (elTotal) elTotal.innerText = String(total);
      if (elVisited) elVisited.innerText = String(visited);
      if (elRate) elRate.innerText = rate + '%';
      if (bar) bar.style.width = rate + '%';
    }

    // ---- 近い順リスト ----
    async function renderNearby(){
      const locStatus = /** @type {HTMLElement|null} */ (document.getElementById('locStatus'));
      const list = /** @type {HTMLElement|null} */ (document.getElementById('spotList'));
      if (!list) return;

      locStatus && (locStatus.textContent = '現在地を取得中…（許可してください）');
      list.innerHTML = '';

      try{
        const pos = await getPosition();
        const { latitude, longitude, accuracy } = pos.coords;
        locStatus && (locStatus.textContent = `現在地: ${latitude.toFixed(5)}, ${longitude.toFixed(5)} ／ 精度 ±${Math.round(accuracy)}m`);

        const rows = SPOTS.map(s => ({ spot: s, dist: distanceMeters(latitude, longitude, s.lat, s.lng) }))
                          .sort((a,b)=> a.dist - b.dist);
        rows.forEach(({spot, dist})=> appendSpotRow(list, spot, Math.max(0, Math.round(dist))));

      }catch(err){
        locStatus && (locStatus.textContent =
          '位置情報が取得できませんでした（HTTPS/サイトの位置許可をご確認ください）。フォールバック表示中。');
        SPOTS.slice().sort((a,b)=> a.name.localeCompare(b.name, 'ja')).forEach(spot => appendSpotRow(list, spot, NaN));
      }
    }

    function appendSpotRow(listEl, spot, dist){
      const visited = isVisited(spot.id);
      const btnLabel = visited ? '訪問済み' : 'チェックイン';
      const btnDisabled = visited ? 'disabled' : '';
      const distText = Number.isNaN(dist) ? '距離不明' : `約${dist}m`;

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="row">
          <div>
            <div class="spot-title">${spot.name}</div>
            <div class="dist">${distText} ／ 判定半径 ${spot.radius_m}m</div>
            ${spot.hint ? `<div class="hint">ヒント：${spot.hint}</div>` : ''}
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="ghost" data-id="${spot.id}" data-action="checkin" ${btnDisabled}>${btnLabel}</button>
          </div>
        </div>
      `;
      listEl.appendChild(card);

      const btn = card.querySelector('button[data-action="checkin"]:not([disabled])');
      if (btn) {
        btn.addEventListener('click', async (e)=>{
          const id = /** @type {HTMLElement} */(e.currentTarget).getAttribute('data-id');
          if (!id) return;
          const s = SPOTS.find(x=> x.id === id);
          if (s) await checkIn(s);
        });
      }
    }

    // ---- スタンプ帳 ----
    function renderStampBook(){
      const wrap = /** @type {HTMLElement|null} */ (document.getElementById('stampGrid'));
      if (!wrap) return;

      const stamps = loadStamps();
      if(!stamps.length){
        wrap.innerHTML = '<p class="hint">まだスタンプはありません。スポットでチェックインして写真を撮るとここに貯まります。</p>';
        return;
      }
      wrap.innerHTML = stamps.map(s => `
        <figure>
          <img src="${s.photoDataUrl}" alt="${s.spotName}">
          <figcaption>${s.spotName}<br>${formatDT(s.takenAtISO)}（約${s.distance_m}m）</figcaption>
        </figure>
      `).join('');
    }

    // ---- チェックイン（先にギャラリー選択 → その後 位置判定） ----
    async function checkIn(spot){
      try{
        if (isVisited(spot.id)) { alert('このスポットは訪問済みです。'); return; }

        // ① 先にギャラリーから選ぶ
        const input = /** @type {HTMLInputElement|null} */ (document.getElementById('camera'));
        if (!input) { alert('画像選択の要素が見つかりません'); return; }
        const photoDataUrl = await new Promise((resolve,reject)=>{
          input.value = '';
          input.onchange = async () => {
            const file = input.files && input.files[0];
            if(!file){ reject(new Error('ファイルが選択されませんでした')); return; }
            try{
              const resized = await resizeImageFileToDataURL(file, 1024);
              resolve(resized);
            }catch(e){ reject(e); }
          };
          if (input.showPicker) { try { input.showPicker(); } catch { input.click(); } }
          else { input.click(); }
        });

        // ② 位置判定
        const pos = await getPosition();
        const { latitude, longitude } = pos.coords;
        const dist = Math.round(distanceMeters(latitude, longitude, spot.lat, spot.lng));
        if(dist > spot.radius_m){
          alert(`まだ遠いかも… 現在 ${dist}m ／ 必要 ${spot.radius_m}m 以内（選んだ写真は保存されません）`);
          return;
        }

        // ③ 保存
        /** @type {Stamp} */
        const stamp = {
          id: String(Date.now()),
          spotId: spot.id,
          spotName: spot.name,
          category: spot.category,
          takenAtISO: nowISO(),
          photoDataUrl: /** @type {string} */(photoDataUrl),
          distance_m: dist
        };
        saveStamp(stamp);
        alert(`チェックイン！「${spot.name}」のスタンプが増えました。`);

        renderStampBook();
        renderNearby();
        renderDashboard();

      }catch(err){
        console.error('checkIn error', err);
        // 選択ダイアログを閉じた等はここに来ます（無視でOK）
      }
    }

    // ---- 初期化 ----
    function init(){
      const btnRefresh = /** @type {HTMLButtonElement|null} */ (document.getElementById('btnRefresh'));
      const btnClear   = /** @type {HTMLButtonElement|null} */ (document.getElementById('btnClear'));
      btnRefresh?.addEventListener('click', () => { renderNearby(); });
      btnClear?.addEventListener('click', () => {
        if (confirm('端末内のスタンプをすべて削除します。よろしいですか？')) {
          clearStamps();
          renderStampBook();
          renderNearby();
          renderDashboard();
        }
      });

      renderDashboard();
      renderNearby();
      renderStampBook();
    }

    window.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
